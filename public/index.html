<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #efeff4; --card: #ffffff; --hint: #8e8e93; --blue: #007aff; --red: #ff3b30; --green: #4cd964; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .grid { display: flex; gap: 10px; margin-bottom: 15px; }
        .card { background: var(--card); padding: 15px; border-radius: 12px; flex: 1; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .label { font-size: 12px; color: var(--hint); text-transform: uppercase; }
        .val { font-size: 20px; font-weight: bold; margin-top: 5px; }
        .history-card { background: var(--card); border-radius: 12px; padding: 10px; margin-top: 15px; }
        .tx-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        canvas { max-height: 200px; }
    </style>
</head>
<body>

    <div class="grid">
        <div class="card">
            <div class="label">Кошелек</div>
            <div class="val" id="wallet">0 ₸</div>
        </div>
        <div class="card" style="border-bottom: 3px solid orange;">
            <div class="label">Копилка</div>
            <div class="val" id="savings">0 ₸</div>
        </div>
    </div>

    <div class="card">
        <div class="label">Расходы по категориям</div>
        <canvas id="chart"></canvas>
    </div>

    <div class="history-card" id="history">
        <div class="label">Последние операции</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const userId = tg.initDataUnsafe?.user?.id || 'test_user';
        let myChart = null;

        async function load() {
            const res = await fetch(`/api/stats/${userId}`);
            const data = await res.json();

            document.getElementById('wallet').innerText = data.wallet + ' ₸';
            document.getElementById('savings').innerText = data.savings + ' ₸';

            // Список истории
            const histDiv = document.getElementById('history');
            histDiv.innerHTML = '<div class="label">Последние операции</div>';
            data.history.reverse().forEach(tx => {
                histDiv.innerHTML += `
                    <div class="tx-item">
                        <div>${tx.cat}</div>
                        <div style="color: ${tx.amount > 0 ? 'var(--green)' : 'black'}">
                            ${tx.amount > 0 ? '+' : ''}${tx.amount}
                        </div>
                    </div>`;
            });

            // График
            const ctx = document.getElementById('chart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.categories),
                    datasets: [{ data: Object.values(data.categories), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'] }]
                }
            });
        }

        tg.expand();
        load();
    </script>
</body>
</html>
