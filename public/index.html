<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 15px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .main { grid-column: span 2; background: #007bff; color: white; }
        .label { font-size: 11px; opacity: 0.8; text-transform: uppercase; }
        .val { font-size: 20px; font-weight: bold; margin-top: 5px; }
        .item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="grid">
        <div class="card main"><div class="label">–ë–∞–ª–∞–Ω—Å üá∞üáø</div><div class="val" id="main">0 ‚Ç∏</div></div>
        <div class="card"><div class="label">–î–µ–ø–æ–∑–∏—Ç üê∑</div><div class="val" id="deposit">0 ‚Ç∏</div></div>
        <div class="card"><div class="label">–Ø –¥–∞–ª (–î–æ–ª–≥)</div><div class="val" id="lent">0 ‚Ç∏</div></div>
        <div class="card"><div class="label">–Ø –≤–∑—è–ª (–î–æ–ª–≥)</div><div class="val" id="borrowed">0 ‚Ç∏</div></div>
    </div>
    <canvas id="chart" style="margin: 20px 0;"></canvas>
    <div id="history" class="card"></div>

    <script>
        const tg = window.Telegram.WebApp;
        async function load() {
            const res = await fetch(`/api/stats/${tg.initDataUnsafe?.user?.id || 'test'}`);
            const data = await res.json();
            document.getElementById('main').innerText = data.main.toLocaleString() + ' ‚Ç∏';
            document.getElementById('deposit').innerText = data.deposit.toLocaleString() + ' ‚Ç∏';
            document.getElementById('lent').innerText = data.lent.toLocaleString() + ' ‚Ç∏';
            document.getElementById('borrowed').innerText = data.borrowed.toLocaleString() + ' ‚Ç∏';
            
            new Chart(document.getElementById('chart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.categories),
                    datasets: [{ data: Object.values(data.categories), backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'] }]
                }
            });

            const hist = document.getElementById('history');
            data.history.slice(0, 10).forEach(tx => {
                hist.innerHTML += `<div class="item"><span>${tx.category}</span><b>${tx.amount} ‚Ç∏</b></div>`;
            });
        }
        tg.expand();
        load();
    </script>
</body>
</html>
