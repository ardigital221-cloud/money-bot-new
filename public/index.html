<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #f2f2f7; --card: #fff; --accent: #007aff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .main-card { grid-column: span 2; background: var(--accent); color: #fff; }
        .label { font-size: 11px; text-transform: uppercase; opacity: 0.7; font-weight: 600; }
        .val { font-size: 22px; font-weight: 800; margin-top: 5px; }
        .history { margin-top: 20px; }
        .item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
        .red { color: #ff3b30; } .green { color: #34c759; }
        canvas { max-height: 200px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="grid">
        <div class="card main-card">
            <div class="label">–ù–∞ —Ä—É–∫–∞—Ö üá∞üáø</div>
            <div class="val" id="main">0 ‚Ç∏</div>
        </div>
        <div class="card"><div class="label">–î–µ–ø–æ–∑–∏—Ç üê∑</div><div class="val" id="deposit">0 ‚Ç∏</div></div>
        <div class="card"><div class="label">–î–∞–ª –≤ –¥–æ–ª–≥ üü¢</div><div class="val" id="lent">0 ‚Ç∏</div></div>
        <div class="card" style="border-left: 4px solid #ff3b30;"><div class="label">–í–∑—è–ª –≤ –¥–æ–ª–≥ üî¥</div><div class="val" id="borrowed">0 ‚Ç∏</div></div>
    </div>

    <canvas id="chart"></canvas>

    <div class="history" id="history"></div>

    <script>
        const tg = window.Telegram.WebApp;
        async function load() {
            tg.HapticFeedback.impactOccurred('light'); // –í–∏–±—Ä–∞—Ü–∏—è
            const res = await fetch(`/api/stats/${tg.initDataUnsafe?.user?.id || 'test'}`);
            const data = await res.json();

            document.getElementById('main').innerText = data.main.toLocaleString() + ' ‚Ç∏';
            document.getElementById('deposit').innerText = data.deposit.toLocaleString() + ' ‚Ç∏';
            document.getElementById('lent').innerText = data.lent.toLocaleString() + ' ‚Ç∏';
            document.getElementById('borrowed').innerText = data.borrowed.toLocaleString() + ' ‚Ç∏';

            new Chart(document.getElementById('chart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.categories),
                    datasets: [{ data: Object.values(data.categories), backgroundColor: ['#007aff', '#34c759', '#ff9500', '#ff3b30'] }]
                }
            });

            const hist = document.getElementById('history');
            data.history.forEach(tx => {
                hist.innerHTML += `<div class="item"><span>${tx.category}</span><span class="${tx.amount > 0 ? 'green' : ''}">${tx.amount.toLocaleString()} ‚Ç∏</span></div>`;
            });
        }
        tg.expand();
        load();
    </script>
</body>
</html>
